_ALIASES:
  - &default_builder_template
    boot_wait: '3s'
    disk_size: 60000
    http_directory: 'http'
    iso_checksum: '{{user `iso_checksum`}}'
    iso_checksum_type: '{{user `iso_checksum_type`}}'
    iso_url: '{{user `mirror`}}/{{user `mirror_directory`}}/{{user `iso_name`}}'
    shutdown_command: 'echo "oem"|sudo -S shutdown -P now'
    ssh_password: 'oem'
    ssh_port: 22
    ssh_username: 'oem'
    ssh_wait_timeout: '10000s'
    headless: '{{ user `headless` }}'
    vm_name: '{{ user `template` }}'
    boot_command:
      - '<tab><wait><bs><bs><bs><bs><bs><bs><bs><bs><bs><bs><bs><bs><bs>'
      - '<bs><bs><bs><bs><bs><bs><bs><bs><bs><bs><bs><bs><bs><bs>'
      - '<bs><bs><bs><bs><bs><bs><bs><bs><bs><wait>'
      - ' auto<wait>'
      - ' console-setup/ask_detect=false<wait>'
      - ' console-setup/layoutcode=us<wait>'
      - ' console-setup/modelcode=pc104<wait>'
      - ' debconf/frontend=noninteractive<wait>'
      - ' debian-installer=en_US.UTF-8<wait>'
      - ' fb=false<wait>'
      - ' initrd=/initrd.gz<wait>'
      - ' kbd-chooser/method=us<wait>'
      - ' keyboard-configuration/layout=USA<wait>'
      - ' keyboard-configuration/variant=USA<wait>'
      - ' locale=en_US.UTF-8<wait>'
      - ' netcfg/get_domain={{ user `domain` }}<wait>'
      - ' netcfg/get_hostname={{ user `hostname` }}<wait>'
      - ' grub-installer/bootdev=/dev/sda<wait>'
      - ' DEBCONF_DEBUG=5<wait>'
      - ' noapic<wait>'
      - ' preseed/url=http://{{ .HTTPIP }}:{{ .HTTPPort }}/{{user `preseed_path`}}<wait>'
      - ' oem-config/enable=true'
      - ' -- <wait>'
      - '<enter><wait>'

builders:
  - <<: *default_builder_template
    type: 'virtualbox-iso'
    output_directory: 'packer-{{user `template`}}-virtualbox'
    guest_additions_path: 'VBoxGuestAdditions_{{.Version}}.iso'
    guest_os_type: 'Ubuntu_64'
    hard_drive_interface: 'sata'
    vboxmanage:
      - [ 'modifyvm', '{{.Name}}', '--memory', '{{ user `memory` }}' ]
      - [ 'modifyvm', '{{.Name}}', '--cpus', '{{ user `cpus` }}' ]
    virtualbox_version_file: '.virtualbox_version'

  - <<: *default_builder_template
    type: 'vmware-iso'
    output_directory: 'packer-{{user `template`}}-vmware'
    guest_os_type: 'ubuntu-64'
    tools_upload_flavor: 'linux'
    vmx_data:
      cpuid.coresPerSocket: 1
      ethernet0.pciSlotNumber: 32
      memsize: '{{ user `memory` }}'
      numvcpus: '{{ user `cpus` }}'

  - <<: *default_builder_template
    type: 'parallels-iso'
    output_directory: 'packer-{{user `template`}}-parallels'
    guest_os_type: 'ubuntu'
    parallels_tools_flavor: 'lin'
    prlctl:
      - [ 'set', '{{.Name}}', '--memsize', '{{ user `memory` }}' ]
      - [ 'set', '{{.Name}}', '--cpus', '{{ user `cpus` }}' ]
    prlctl_version_file: '.prlctl_version'

  - <<: *default_builder_template
    type: 'qemu'
    output_directory: 'packer-{{user `template`}}-qemu'
    qemuargs:
      - [ '-m', '{{ user `memory` }}' ]
      - [ '-smp', '{{ user `cpus` }}' ]
    # TODO:  Find a nicer way of doing this.
    boot_command:
      - '<tab><wait><bs><bs><bs><bs><bs><bs><bs><bs><bs><bs><bs><bs><bs>'
      - '<bs><bs><bs><bs><bs><bs><bs><bs><bs><bs><bs><bs><bs><bs>'
      - '<bs><bs><bs><bs><bs><bs><bs><bs><bs><wait>'
      - ' auto<wait>'
      - ' console-setup/ask_detect=false<wait>'
      - ' console-setup/layoutcode=us<wait>'
      - ' console-setup/modelcode=pc104<wait>'
      - ' debconf/frontend=noninteractive<wait>'
      - ' debian-installer=en_US.UTF-8<wait>'
      - ' fb=false<wait>'
      - ' initrd=/initrd.gz<wait>'
      - ' kbd-chooser/method=us<wait>'
      - ' keyboard-configuration/layout=USA<wait>'
      - ' keyboard-configuration/variant=USA<wait>'
      - ' locale=en_US.UTF-8<wait>'
      - ' netcfg/get_domain={{ user `domain` }}<wait>'
      - ' netcfg/get_hostname={{ user `hostname` }}<wait>'
      - ' grub-installer/bootdev=/dev/vda<wait>'
      - ' DEBCONF_DEBUG=5<wait>'
      - ' noapic<wait>'
      - ' preseed/url=http://{{ .HTTPIP }}:{{ .HTTPPort }}/{{user `preseed_path`}}<wait>'
      - ' oem-config/enable=true'
      - ' -- <wait>'
      - '<enter><wait>'

provisioners:
  - type: file
    source: '{{ user `metadata` }}'
    destination: '/tmp/bento-metadata.json'
  - type: shell
    environment_vars:
      - 'HOME_DIR=/home/oem'
      - 'http_proxy={{ user `http_proxy` }}'
      - 'https_proxy={{ user `https_proxy` }}'
      - 'no_proxy={{ user `no_proxy` }}'
    execute_command: 'echo "oem" | {{.Vars}} sudo -S -E sh -eux "{{.Path}}"'
    scripts:
      - 'scripts/common/metadata.sh'
      - 'scripts/ubuntu/update.sh'
      - 'scripts/common/sshd.sh'
      - 'scripts/ubuntu/networking.sh'
      - 'scripts/common/virtualbox.sh'
      - 'scripts/ubuntu/vmware.sh'
      - 'scripts/common/parallels.sh'
      - 'scripts/ubuntu/cleanup.sh'
      - 'scripts/common/minimize.sh'
      - 'scripts/ubuntu/oem.sh'

variables:
  box_basename: 'ubuntu-16.04'
  build_timestamp: '{{isotime "20060102150405"}}'
  cpus: '1'
  disk_size: '40960'
  git_revision: '__unknown_git_revision__'
  headless: ''
  http_proxy: '{{env `http_proxy`}}'
  https_proxy: '{{env `https_proxy`}}'
  iso_checksum: '655d1ec0a7415b4d963e7f2c40e3d56bd135907dda2cedd0c75209ced3a63103'
  iso_checksum_type: 'sha256'
  iso_name: 'mini.iso'
  memory: '2048'
  metadata: 'floppy/dummy_metadata.json'
  mirror: 'http://mirror.science.uoit.ca/ubuntu'
  mirror_directory: 'dists/xenial/main/installer-amd64/current/images/netboot'
  name: 'ubuntu-16.04'
  no_proxy: '{{env `no_proxy`}}'
  preseed_path: 'xubuntu-16.04/preseed.cfg'
  template: 'ubuntu-16.04-amd64'
  version: '2.1.TIMESTAMP'
  hostname: 'UOIT'
  domain: 'local'
